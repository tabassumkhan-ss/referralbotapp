<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ref786App ‚Äî Smart Referral System</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0; height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      text-align:center; color:#fff;
      background: radial-gradient(1200px 600px at 50% -20%, rgba(255,255,255,.08), transparent 60%),
                  linear-gradient(135deg, #5c3cff, #0e1630 60%);
      overflow:auto; padding:18px;
    }
    .card {
      width:min(720px, 96vw);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      margin: 0 auto;
    }

    /* Avatar + neon glow (after register) */
    .logo {
      width: 88px; height: 88px; border-radius: 50%; object-fit: cover;
      border: 4px solid rgba(255,255,255,.35); margin: 0 auto 14px; display:block;
      box-shadow: 0 10px 26px rgba(0,0,0,.35), 0 0 0 8px rgba(255,255,255,.08) inset;
      position: relative;
    }
    .logo.glow { border-color: transparent; box-shadow: none; isolation:isolate; }
    .logo.glow::before, .logo.glow::after {
      content: ""; position: absolute; inset: -6px; border-radius: 50%; z-index: -1;
    }
    .logo.glow::before {
      background: conic-gradient(from 0deg,#6cf 0%,#8af 25%,#9ff 50%,#7df 75%,#6cf 100%);
      filter: blur(6px); animation: spin 4s linear infinite; opacity: .95;
    }
    .logo.glow::after {
      inset: -14px; background: radial-gradient(closest-side, rgba(108,240,255,.5), rgba(0,0,0,0));
      filter: blur(10px); opacity: .65;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    h2 { margin:0 0 10px; font-weight:700; }
    .row { margin:10px 0; font-size:1.05rem; }
    .big { font-size:1.25rem; font-weight:700; }

    .actions { margin-top:16px; display:flex; gap:12px; justify-content:center; }
    .btn {
      padding:11px 22px; border-radius:22px; border:0; cursor:pointer; font-weight:600;
      background:#00c853; color:#fff; box-shadow:0 8px 24px rgba(0,200,83,.35);
    }
    .btn.alt { background:#e53935; box-shadow:0 8px 24px rgba(229,57,53,.35); }

    /* Referral line */
    .ref-line { display:flex; align-items:center; justify-content:center; gap:10px; margin-top:8px; }
    .copy-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:10px; border:none; cursor:pointer;
      background: rgba(255,255,255,.16); color:#fff; font-size:18px;
      transition: transform .12s ease, opacity .2s;
    }
    .copy-btn:active { transform: scale(.96); }
    .hint { font-size:.85rem; opacity:.85; margin-top:8px; }
    .tooltip { margin-top:8px; font-size:.85rem; opacity:0; transition:opacity .25s; }
    .show { opacity:1; }

    /* Deposit panel */
    .panel { margin-top:18px; text-align:left; background:rgba(0,0,0,.18); padding:16px; border-radius:14px; }
    .panel h3 { margin:0 0 10px; color:#fff; }
    label { display:block; font-size:.95rem; opacity:.9; margin:10px 0 6px; }
    input, .addr-box {
      width:100%; padding:12px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08); color:#fff; outline:none;
    }
    .split { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
    .rowline { display:flex; align-items:center; gap:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break: break-all; }
    .mini { font-size:.9rem; opacity:.9; }
    .submit { margin-top:14px; text-align:right; }
    .btn.secondary { background:#2a7de1; box-shadow:0 8px 24px rgba(42,125,225,.35); }
    .error { color:#ffb4b4; font-size:.9rem; margin-top:6px; }
    .ok    { color:#b5ffcb; font-size:.9rem; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card" id="app">
    <!-- Initial register screen -->
    <img src="./Botlogo.png" alt="Ref786App Logo" class="logo" id="avatar" />
    <h2>Do you want to Register?</h2>
    <div class="actions">
      <button class="btn" id="yesBtn">‚úÖ Yes</button>
      <button class="btn alt" id="noBtn">‚ùå No</button>
    </div>
  </div>

  <script>
    // ---------- Telegram WebApp setup ----------
    const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
    const app = document.getElementById('app');
    const baseLogo = './Botlogo.png';

    // ---------- Config: replace with your real receiving addresses ----------
    const ADDR_MUSD = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
    const ADDR_MSTC = "0x7e6916Af95714BE309cF3eee98149074921D93e0";
    const CHAIN_LABEL = "EVM Chain"; // e.g., "MST Chain (EVM)" or "BSC"

    // ---------- Context + persistence helpers ----------
    function hasContext() {
      return !!(tg.initData && tg.initDataUnsafe && tg.initDataUnsafe.user);
    }
    function savePendingPayload(key, data) {
      try { localStorage.setItem(key, JSON.stringify(data)); } catch {}
    }
    function loadPendingPayload(key) {
      try { return JSON.parse(localStorage.getItem(key) || "null"); } catch { return null; }
    }
    function clearPendingPayload(key) {
      try { localStorage.removeItem(key); } catch {}
    }

    // Auto-resume a pending deposit when app is opened from the chat
    (function autoResume() {
      const pending = loadPendingPayload("pending_deposit");
      if (pending && hasContext()) {
        try { tg.sendData(JSON.stringify(pending)); } catch {}
        clearPendingPayload("pending_deposit");
        tg.close(); // show the bot's confirmation immediately
      }
    })();

    // ---------- UI helpers ----------
    function copyText(text, tooltipEl) {
      navigator.clipboard.writeText(text).then(() => {
        tooltipEl.classList.add('show');
        setTimeout(() => tooltipEl.classList.remove('show'), 1200);
        try { tg.HapticFeedback?.impactOccurred('medium'); } catch {}
      }).catch(() => alert('Failed to copy'));
    }
    function fmt(n){ return Number(n).toFixed(2); }

    // Render the confirmation + deposit panel
    function renderRegisteredView(userId, name, avatarUrl) {
      const referralUrl = `https://t.me/ref786bot?start=${userId}`;
      app.innerHTML = `
        <img src="${avatarUrl || baseLogo}" alt="User Avatar" class="logo glow" />
        <div class="row big">${userId ?? '(unknown)'}</div>
        <div class="row">${name || 'Unknown'}</div>

        <div class="row ref-line">
          <span>Referral Link</span>
          <button class="copy-btn" id="copyRef" title="Copy referral link">üìã</button>
        </div>
        <div class="hint">Tap to copy your referral link</div>
        <div class="tooltip" id="tooltipRef">Copied!</div>

        <div class="panel">
          <h3>üí≥ Deposit</h3>
          <div class="mini">Minimum deposit ‚Äî <b>$20</b>. Split will be <b>50% MUSD</b> and <b>50% MSTC</b>.</div>

          <label>Enter USD amount</label>
          <input id="amt" type="number" min="20" step="0.01" placeholder="e.g., 20.00" />
          <div id="amtErr" class="error" style="display:none;"></div>

          <div class="split">
            <div>
              <div class="mini">MUSD (50%)</div>
              <div class="rowline"><span id="musdAmt" class="big">0.00</span> <span class="mini">USD</span></div>
              <label class="mini" style="margin-top:8px;">Send to (MUSD address)</label>
              <div class="addr-box mono" id="addrMUSD">${ADDR_MUSD}</div>
              <div class="rowline" style="margin-top:6px;">
                <button class="copy-btn" id="copyMUSD">üìã</button><span class="mini">${CHAIN_LABEL}</span>
              </div>
              <label class="mini" style="margin-top:8px;">MUSD Tx Hash</label>
              <input id="txMUSD" type="text" placeholder="Paste transaction hash" />
            </div>

            <div>
              <div class="mini">MSTC (50%)</div>
              <div class="rowline"><span id="mstcAmt" class="big">0.00</span> <span class="mini">USD</span></div>
              <label class="mini" style="margin-top:8px;">Send to (MSTC address)</label>
              <div class="addr-box mono" id="addrMSTC">${ADDR_MSTC}</div>
              <div class="rowline" style="margin-top:6px;">
                <button class="copy-btn" id="copyMSTC">üìã</button><span class="mini">${CHAIN_LABEL}</span>
              </div>
              <label class="mini" style="margin-top:8px;">MSTC Tx Hash</label>
              <input id="txMSTC" type="text" placeholder="Paste transaction hash" />
            </div>
          </div>

          <div class="submit">
            <button class="btn secondary" id="submitDeposit">Submit Deposit</button>
          </div>
          <div id="submitMsg" class="ok" style="display:none;">Submitted! We‚Äôll verify your transactions shortly.</div>
        </div>
      `;

      // Referral copy
      const tooltipRef = document.getElementById('tooltipRef');
      document.getElementById('copyRef').onclick = () => copyText(referralUrl, tooltipRef);

      // Amount logic
      const amt = document.getElementById('amt');
      const musdAmtEl = document.getElementById('musdAmt');
      const mstcAmtEl = document.getElementById('mstcAmt');
      const errEl = document.getElementById('amtErr');

      function recalc() {
        const v = parseFloat(amt.value || '0');
        if (isNaN(v) || v <= 0) {
          musdAmtEl.textContent = '0.00';
          mstcAmtEl.textContent = '0.00';
          errEl.style.display = 'none';
          return;
        }
        musdAmtEl.textContent = fmt(v/2);
        mstcAmtEl.textContent = fmt(v/2);
        errEl.style.display = (v < 20) ? 'block' : 'none';
        errEl.textContent = (v < 20) ? 'Minimum deposit is $20.' : '';
      }
      amt.addEventListener('input', recalc);

      // Copy address buttons
      document.getElementById('copyMUSD').onclick = () => mkCopy(ADDR_MUSD);
      document.getElementById('copyMSTC').onclick = () => mkCopy(ADDR_MSTC);
      function mkCopy(value){
        const tip = document.createElement('div');
        tip.className = 'tooltip show';
        tip.textContent = 'Copied!';
        app.appendChild(tip);
        copyText(value, tip);
        setTimeout(()=>{ try{ tip.remove(); }catch{} },1000);
      }

      // Submit deposit ‚Äî robust: send if context, else save & deep-link
      document.getElementById('submitDeposit').onclick = () => {
        const v  = parseFloat(amt.value || '0');
        const tx1 = document.getElementById('txMUSD').value.trim();
        const tx2 = document.getElementById('txMSTC').value.trim();
        const submitMsg = document.getElementById('submitMsg');

        if (isNaN(v) || v < 20) {
          errEl.style.display = 'block';
          errEl.textContent = 'Please enter at least $20.';
          return;
        }
        if (!tx1 || !tx2) {
          errEl.style.display = 'block';
          errEl.textContent = 'Please paste both transaction hashes.';
          return;
        }

        const u = tg.initDataUnsafe?.user || {};
        const payload = {
          action: 'deposit_submitted',
          user_id: u.id ?? null,
          name: [u.first_name, u.last_name].filter(Boolean).join(' ')
                || (u.username ? '@'+u.username : 'Unknown'),
          amount_usd: v,
          musd_usd: v/2,
          mstc_usd: v/2,
          tx_musd: tx1,
          tx_mstc: tx2
        };

        submitMsg.style.display = 'block';

        if (hasContext()) {
          try { tg.sendData(JSON.stringify(payload)); } catch {}
          tg.close(); // show the bot‚Äôs reply immediately
        } else {
          // No chat context: save & deep-link to bot, auto-send on next open
          savePendingPayload("pending_deposit", payload);
          if (tg.openTelegramLink) {
            tg.openTelegramLink("https://t.me/ref786bot?start=resume_deposit");
          } else {
            window.location.href = "https://t.me/ref786bot?start=resume_deposit";
          }
        }
      };
    }

    // Register button behavior
    document.getElementById('yesBtn').onclick = () => {
      const u = tg.initDataUnsafe?.user || {};
      const id   = u.id ?? null; // if opened "in web", id can be null
      const name = [u.first_name, u.last_name].filter(Boolean).join(' ')
                || (u.username ? '@' + u.username : 'Unknown');
      const avatarUrl = u.photo_url || baseLogo;
      renderRegisteredView(id, name, avatarUrl);
      try { tg.HapticFeedback?.notificationOccurred('success'); } catch {}
    };

    document.getElementById('noBtn').onclick = () => {
      app.innerHTML = `
        <img src="${baseLogo}" alt="Ref786App Logo" class="logo" />
        <div class="row big">‚ùå Registration Cancelled</div>
      `;
      try { tg.HapticFeedback?.notificationOccurred('error'); } catch {}
    };
  </script>
</body>
</html>
